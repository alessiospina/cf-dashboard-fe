name: Build & Push Frontend

on:
  push:
    tags:
      - "v*"

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout codice
        uses: actions/checkout@v4

      - name: Configura Docker per registry HTTP (insecure)
        run: |
          echo '{"insecure-registries":["${{ secrets.REGISTRY_HOST }}"]}' | sudo tee /etc/docker/daemon.json
          sudo systemctl restart docker
          sleep 5

      - name: Login al registry privato
        run: |
          echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login ${{ secrets.REGISTRY_HOST }} \
            -u ${{ secrets.REGISTRY_USER }} --password-stdin

      - name: Build immagine
        run: |
          docker build \
            --build-arg VITE_API_PROTOCOL=${{ secrets.VITE_API_PROTOCOL }} \
            --build-arg VITE_API_HOST=${{ secrets.VITE_API_HOST }} \
            --build-arg VITE_API_PORT=${{ secrets.VITE_API_PORT }} \
            -t ${{ secrets.REGISTRY_HOST }}/cf-dashboard-fe:${{ github.ref_name }} \
            -t ${{ secrets.REGISTRY_HOST }}/cf-dashboard-fe:latest \
            .

      - name: Push immagine
        run: |
          docker push ${{ secrets.REGISTRY_HOST }}/cf-dashboard-fe:${{ github.ref_name }}
          docker push ${{ secrets.REGISTRY_HOST }}/cf-dashboard-fe:latest
